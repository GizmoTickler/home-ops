---
# yaml-language-server: $schema=https://kubernetes-schema.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: netbox
spec:
  chartRef:
    kind: OCIRepository
    name: netbox
  interval: 1h
  values:
    image:
      repository: netbox-community/netbox
      registry: ghcr.io
      pullPolicy: IfNotPresent

    # Superuser configuration
    superuser:
      name: admin
      email: admin@${SECRET_DOMAIN}
      existingSecret: netbox-secret
      existingSecretKey: superuser_password
      apiTokenExistingSecret: netbox-secret
      apiTokenExistingSecretKey: superuser_api_token

    # Existing secret for Django secret key
    existingSecret: netbox-secret

    # Skip startup scripts (fresh install)
    skipStartupScripts: false

    # Use external PostgreSQL (CNPG cluster)
    postgresql:
      enabled: false

    externalDatabase:
      host: netbox-postgres-rw.database.svc.cluster.local
      port: 5432
      database: netbox
      username: netbox
      existingSecretName: netbox-db-secret
      existingSecretKey: password

    # Use bundled Valkey (Redis-compatible)
    valkey:
      enabled: true
      architecture: standalone
      auth:
        enabled: true
        existingSecret: netbox-secret
        existingSecretPasswordKey: redis_password
      primary:
        persistence:
          enabled: false
        resourcesPreset: none
        resources:
          requests:
            cpu: 50m
            memory: 256Mi
          limits:
            memory: 1Gi

    # Task/cache Redis configuration (uses bundled Valkey)
    tasksRedis:
      host: "{{ .Release.Name }}-valkey-master"
      existingSecretName: netbox-secret
      existingSecretKey: redis_password

    cachingRedis:
      host: "{{ .Release.Name }}-valkey-master"
      existingSecretName: netbox-secret
      existingSecretKey: redis_password

    # Remote authentication (PocketID OIDC)
    # Note: remoteAuth.backends sets REMOTE_AUTH_BACKEND which becomes AUTHENTICATION_BACKENDS
    remoteAuth:
      enabled: true
      backends:
        - social_core.backends.open_id_connect.OpenIdConnectAuth
      autoCreateUser: true
      # Auto-promote users to superuser/staff
      superusers:
        - a99940218
      superuserGroups:
        - admin
      staffGroups:
        - admin

    # Extra configuration for OIDC settings
    # Secret contains oidc.yaml with KEY and SECRET
    # ConfigMap contains oidc.yaml with endpoint, scopes, username mapping
    extraConfig:
      - secret:
          secretName: netbox-secret
          items:
            - key: oidc.yaml
              path: oidc-creds.yaml
      - configMap:
          name: netbox-oidc-config
          items:
            - key: oidc.yaml
              path: oidc-settings.yaml

    # Mount custom pipeline module for social-auth
    extraVolumes:
      - name: oidc-pipeline
        configMap:
          name: netbox-oidc-config
          items:
            - key: oidc_pipeline.py
              path: oidc_pipeline.py

    extraVolumeMounts:
      - name: oidc-pipeline
        mountPath: /opt/netbox/netbox/oidc_pipeline.py
        subPath: oidc_pipeline.py
        readOnly: true

    # Housekeeping job (disabled for initial deployment)
    housekeeping:
      enabled: false

    # Worker for background tasks
    worker:
      enabled: true
      replicaCount: 1
      resources:
        requests:
          cpu: 50m
          memory: 128Mi
        limits:
          memory: 512Mi

    # Main application
    replicaCount: 1

    resources:
      requests:
        cpu: 50m
        memory: 256Mi
      limits:
        memory: 1Gi

    # Persistence disabled - all data lives in PostgreSQL
    # Media uploads can be added later if needed
    persistence:
      enabled: false

    reportsPersistence:
      enabled: false

    scriptsPersistence:
      enabled: false

    # Service configuration
    service:
      type: ClusterIP
      port: 80

    # Disable built-in ingress (using Gateway API)
    ingress:
      enabled: false

    # Pod security
    podSecurityContext:
      runAsNonRoot: true
      runAsUser: 1000
      runAsGroup: 1000
      fsGroup: 1000
      fsGroupChangePolicy: OnRootMismatch

    securityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      capabilities:
        drop:
          - ALL

    # Probes - extended for initial migrations
    startupProbe:
      enabled: true
      initialDelaySeconds: 60
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 60  # 10 minutes for migrations

    readinessProbe:
      enabled: true
      initialDelaySeconds: 5
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 6
      successThreshold: 1

    livenessProbe:
      enabled: true
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 6
      successThreshold: 1

    # Service account
    serviceAccount:
      create: true

    # Metrics
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
---
# HTTPRoute for Gateway API
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: netbox
spec:
  parentRefs:
    - name: envoy-internal
      namespace: network
      sectionName: https
  hostnames:
    - netbox.${SECRET_DOMAIN}
  rules:
    # Redirect /login/ to OIDC login
    - matches:
        - path:
            type: Exact
            value: /login/
      filters:
        - type: RequestRedirect
          requestRedirect:
            path:
              type: ReplaceFullPath
              replaceFullPath: /oauth/login/oidc/
            statusCode: 302
    # All other traffic to NetBox
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: netbox
          port: 80
