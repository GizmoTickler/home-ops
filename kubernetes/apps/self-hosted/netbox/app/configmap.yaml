---
apiVersion: v1
kind: ConfigMap
metadata:
  name: netbox-oidc-config
data:
  # Custom pipeline for social-auth to set superuser/staff status
  oidc_pipeline.py: |
    """Custom social-auth pipeline for NetBox OIDC authentication."""

    # Usernames that should be superusers
    SUPERUSERS = ['a99940218']
    # Groups that should grant superuser status
    SUPERUSER_GROUPS = ['admin']
    # Groups that should grant staff status
    STAFF_GROUPS = ['admin']

    def set_superuser_status(strategy, details, backend, user=None, *args, **kwargs):
        """Set superuser/staff status based on username or OIDC groups."""
        if user is None:
            return

        changed = False

        # Check username
        if user.username in SUPERUSERS:
            if not user.is_superuser:
                user.is_superuser = True
                user.is_staff = True
                changed = True

        # Check groups from OIDC claims (if available)
        response = kwargs.get('response', {})
        groups = response.get('groups', [])

        for group in groups:
            if group in SUPERUSER_GROUPS:
                if not user.is_superuser:
                    user.is_superuser = True
                    user.is_staff = True
                    changed = True
            elif group in STAFF_GROUPS:
                if not user.is_staff:
                    user.is_staff = True
                    changed = True

        if changed:
            user.save()

  oidc.yaml: |
    # OIDC Configuration for PocketID
    # Note: AUTHENTICATION_BACKENDS is set via remoteAuth.backends in HelmRelease

    # OIDC endpoint (substituted by Flux)
    SOCIAL_AUTH_OIDC_OIDC_ENDPOINT: "https://id.${SECRET_DOMAIN}"

    # Map OIDC claims to user attributes
    SOCIAL_AUTH_OIDC_USERNAME_KEY: preferred_username

    # OIDC scopes
    SOCIAL_AUTH_OIDC_SCOPE:
      - openid
      - profile
      - email

    # Security settings for HTTPS behind reverse proxy
    SESSION_COOKIE_SECURE: true
    CSRF_COOKIE_SECURE: true
    CSRF_TRUSTED_ORIGINS:
      - "https://netbox.${SECRET_DOMAIN}"
      - "https://id.${SECRET_DOMAIN}"

    # Custom social-auth pipeline with superuser promotion
    SOCIAL_AUTH_PIPELINE:
      - social_core.pipeline.social_auth.social_details
      - social_core.pipeline.social_auth.social_uid
      - social_core.pipeline.social_auth.auth_allowed
      - social_core.pipeline.social_auth.social_user
      - social_core.pipeline.user.get_username
      - social_core.pipeline.user.create_user
      - oidc_pipeline.set_superuser_status
      - social_core.pipeline.social_auth.associate_user
      - social_core.pipeline.social_auth.load_extra_data
      - social_core.pipeline.user.user_details

