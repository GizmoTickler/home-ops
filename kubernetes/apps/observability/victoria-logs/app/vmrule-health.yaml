---
# yaml-language-server: $schema=https://kubernetes-schema.pages.dev/operator.victoriametrics.com/vmrule_v1beta1.json
apiVersion: operator.victoriametrics.com/v1beta1
kind: VMRule
metadata:
  name: victoria-logs-health
spec:
  groups:
    # VictoriaLogs Server Health Rules
    - name: victorialogs.rules
      rules:
        - alert: VictoriaLogsDown
          expr: |-
            absent(up{job="victoria-logs-server"}) or up{job="victoria-logs-server"} == 0
          for: 5m
          keep_firing_for: 5m
          annotations:
            summary: >-
              VictoriaLogs server is down
            description: >-
              VictoriaLogs has been unavailable for more than 5 minutes. Log ingestion and queries are failing.
            runbook_url: https://docs.victoriametrics.com/victorialogs/
          labels:
            severity: critical

        - alert: VictoriaLogsStorageNearlyFull
          expr: |-
            (vl_free_disk_space_bytes{job="victoria-logs-server"} / vl_disk_space_limit_bytes{job="victoria-logs-server"}) < 0.2
          for: 15m
          keep_firing_for: 10m
          annotations:
            summary: >-
              VictoriaLogs storage is nearly full
            description: >-
              VictoriaLogs has less than 20% free disk space remaining ({{ $value | humanizePercentage }} free). Consider increasing retention or storage size.
            runbook_url: https://docs.victoriametrics.com/victorialogs/#storage
          labels:
            severity: critical

        - alert: VictoriaLogsIngestionStalled
          expr: |-
            rate(vl_rows_ingested_total{job="victoria-logs-server"}[10m]) == 0
          for: 15m
          keep_firing_for: 5m
          annotations:
            summary: >-
              VictoriaLogs log ingestion has stalled
            description: >-
              VictoriaLogs has not ingested any logs in the last 15 minutes. Check log shippers (Fluent-Bit, Vector).
            runbook_url: https://docs.victoriametrics.com/victorialogs/
          labels:
            severity: warning

        - alert: VictoriaLogsHighIngestionRate
          expr: |-
            rate(vl_rows_ingested_total{job="victoria-logs-server"}[5m]) > 100000
          for: 15m
          keep_firing_for: 5m
          annotations:
            summary: >-
              VictoriaLogs ingestion rate is unusually high
            description: >-
              VictoriaLogs is ingesting {{ $value | humanize }} logs/sec, which may indicate a log explosion or misconfigured shipper.
            runbook_url: https://docs.victoriametrics.com/victorialogs/
          labels:
            severity: warning

        - alert: VictoriaLogsHighErrorRate
          expr: |-
            rate(vl_http_request_errors_total{job="victoria-logs-server"}[5m]) > 10
          for: 10m
          keep_firing_for: 5m
          annotations:
            summary: >-
              VictoriaLogs is experiencing high error rate
            description: >-
              VictoriaLogs has {{ $value }} HTTP errors per second. Check server logs for details.
            runbook_url: https://docs.victoriametrics.com/victorialogs/
          labels:
            severity: warning

        - alert: VictoriaLogsSlowQueries
          expr: |-
            histogram_quantile(0.99, sum(rate(vl_http_request_duration_seconds_bucket{job="victoria-logs-server",path=~"/select.*"}[5m])) by (le)) > 10
          for: 10m
          keep_firing_for: 5m
          annotations:
            summary: >-
              VictoriaLogs query latency is high
            description: >-
              VictoriaLogs p99 query latency is {{ $value | humanizeDuration }}, which may affect log search performance.
            runbook_url: https://docs.victoriametrics.com/victorialogs/logsql/
          labels:
            severity: warning

        - alert: VictoriaLogsHighMemoryUsage
          expr: |-
            (process_resident_memory_bytes{job="victoria-logs-server"} / on() group_left() kube_pod_container_resource_limits{resource="memory",container="server"}) > 0.85
          for: 10m
          keep_firing_for: 5m
          annotations:
            summary: >-
              VictoriaLogs memory usage is high
            description: >-
              VictoriaLogs is using {{ $value | humanizePercentage }} of its memory limit. Consider increasing memory limits.
            runbook_url: https://docs.victoriametrics.com/victorialogs/
          labels:
            severity: warning

    # VMAlert (Logs) Health Rules
    - name: vmalert-logs.rules
      rules:
        - alert: VMAlertLogsDown
          expr: |-
            absent(up{job="vmalert-logs"}) or up{job="vmalert-logs"} == 0
          for: 5m
          keep_firing_for: 5m
          annotations:
            summary: >-
              VMAlert (logs) is down
            description: >-
              VMAlert for VictoriaLogs has been unavailable for more than 5 minutes. Log-based alert evaluation has stopped.
            runbook_url: https://docs.victoriametrics.com/victoriametrics/vmalert/
          labels:
            severity: critical

        - alert: VMAlertLogsEvaluationFailures
          expr: |-
            rate(vmalert_iteration_total{job="vmalert-logs",result="error"}[5m]) > 0
          for: 10m
          keep_firing_for: 5m
          annotations:
            summary: >-
              VMAlert (logs) is experiencing rule evaluation failures
            description: >-
              VMAlert (logs) has {{ $value }} evaluation failures per second. Check LogsQL syntax and VictoriaLogs connectivity.
            runbook_url: https://docs.victoriametrics.com/victoriametrics/vmalert/
          labels:
            severity: warning

        - alert: VMAlertLogsHighEvaluationLatency
          expr: |-
            histogram_quantile(0.99, sum(rate(vmalert_iteration_duration_seconds_bucket{job="vmalert-logs"}[5m])) by (le)) > 60
          for: 10m
          keep_firing_for: 5m
          annotations:
            summary: >-
              VMAlert (logs) rule evaluation is slow
            description: >-
              VMAlert (logs) p99 evaluation latency is {{ $value | humanizeDuration }}. This may delay log-based alert notifications.
            runbook_url: https://docs.victoriametrics.com/victoriametrics/vmalert/
          labels:
            severity: warning

        - alert: VMAlertLogsNotificationFailures
          expr: |-
            rate(vmalert_alerts_send_errors_total{job="vmalert-logs"}[5m]) > 0
          for: 5m
          keep_firing_for: 5m
          annotations:
            summary: >-
              VMAlert (logs) cannot send notifications
            description: >-
              VMAlert (logs) has {{ $value }} notification failures per second. Check Alertmanager connectivity.
            runbook_url: https://docs.victoriametrics.com/victoriametrics/vmalert/
          labels:
            severity: critical

        - alert: VMAlertLogsNoRulesLoaded
          expr: |-
            vmalert_alerting_rules_loaded{job="vmalert-logs"} == 0
          for: 10m
          keep_firing_for: 5m
          annotations:
            summary: >-
              VMAlert (logs) has no rules loaded
            description: >-
              VMAlert (logs) has no alerting rules loaded. Check VMRule resources with label 'rule-type: vlogs'.
            runbook_url: https://docs.victoriametrics.com/victoriametrics/vmalert/
          labels:
            severity: warning

    # Log Shipper Health Rules
    - name: log-shippers.rules
      rules:
        - alert: FluentBitDown
          expr: |-
            absent(up{job="fluent-bit"}) or up{job="fluent-bit"} == 0
          for: 5m
          keep_firing_for: 5m
          annotations:
            summary: >-
              Fluent-Bit is down
            description: >-
              Fluent-Bit has been unavailable for more than 5 minutes. Kubernetes container logs are not being collected.
            runbook_url: https://docs.fluentbit.io/manual/administration/troubleshooting
          labels:
            severity: critical

        - alert: FluentBitHighRetryRate
          expr: |-
            rate(fluentbit_output_retries_total[5m]) > 10
          for: 10m
          keep_firing_for: 5m
          annotations:
            summary: >-
              Fluent-Bit has high retry rate
            description: >-
              Fluent-Bit has {{ $value }} retries per second. Check output connectivity.
            runbook_url: https://docs.fluentbit.io/manual/administration/troubleshooting
          labels:
            severity: warning

        - alert: FluentBitHighDroppedRecords
          expr: |-
            rate(fluentbit_output_dropped_records_total[5m]) > 100
          for: 10m
          keep_firing_for: 5m
          annotations:
            summary: >-
              Fluent-Bit is dropping records
            description: >-
              Fluent-Bit is dropping {{ $value }} records per second. Check buffer configuration and output health.
            runbook_url: https://docs.fluentbit.io/manual/administration/troubleshooting
          labels:
            severity: warning

        - alert: VectorSyslogDown
          expr: |-
            absent(up{job="vector-syslog"}) or up{job="vector-syslog"} == 0
          for: 5m
          keep_firing_for: 5m
          annotations:
            summary: >-
              Vector syslog is down
            description: >-
              Vector syslog aggregator has been unavailable for more than 5 minutes. Network device logs are not being collected.
            runbook_url: https://vector.dev/docs/administration/troubleshooting/
          labels:
            severity: critical

        - alert: VectorSyslogHighErrorRate
          expr: |-
            rate(vector_component_errors_total{component_kind="sink",component_id="victoria_logs"}[5m]) > 10
          for: 10m
          keep_firing_for: 5m
          annotations:
            summary: >-
              Vector syslog has high error rate
            description: >-
              Vector syslog has {{ $value }} errors per second on VictoriaLogs sink. Check connectivity and log format.
            runbook_url: https://vector.dev/docs/administration/troubleshooting/
          labels:
            severity: warning
