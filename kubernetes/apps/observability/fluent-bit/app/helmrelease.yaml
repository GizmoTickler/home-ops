---
# yaml-language-server: $schema=https://kubernetes-schema.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: fluent-bit
spec:
  chartRef:
    kind: OCIRepository
    name: fluent-bit
  interval: 1h
  values:
    config:
      service: |-
        [SERVICE]
          daemon off
          flush {{ .Values.flush }}
          log_level {{ .Values.logLevel }}
          parsers_file /fluent-bit/etc/parsers.conf
          parsers_file /fluent-bit/etc/conf/custom_parsers.conf
          http_server on
          http_listen 0.0.0.0
          http_port {{ .Values.metricsPort }}
          health_check on
          # Persistent storage for reliability during restarts
          storage.path /var/log/flb-storage/
          storage.sync normal
          storage.checksum off
          storage.backlog.mem_limit 10M

      inputs: |-
        [INPUT]
          name tail
          alias kubernetes
          path /var/log/containers/*.log
          tag kubernetes.*
          skip_empty_lines on
          skip_long_lines on
          # Multiline handling for stack traces (docker/cri format)
          multiline.parser docker, cri
          # Storage buffer for reliability
          storage.type filesystem
          mem_buf_limit 10MB
          # Continue from last position on restart
          db /var/log/flb-storage/tail.db
          db.sync normal

      filters: |-
        [FILTER]
          name kubernetes
          match kubernetes.*
          merge_log on
          merge_log_key log_parsed
          kube_tag_prefix kubernetes.var.log.containers.
          k8s-logging.parser on
          k8s-logging.exclude on
          namespace_labels off
          annotations off
          # Enable pod labels for better filtering
          labels on
          # Cache metadata to reduce Kubernetes API calls
          kube_meta_cache_ttl 300s
          # Larger buffer for high-volume pods
          buffer_size 5MB

        [FILTER]
          name nest
          match kubernetes.*
          operation lift
          nested_under kubernetes
          add_prefix k_

        [FILTER]
          name nest
          match kubernetes.*
          operation lift
          nested_under k_labels
          add_prefix k_labels_

        [FILTER]
          name modify
          match kubernetes.*
          rename k_labels_app.kubernetes.io/name app
          rename k_labels_app app
          rename k_labels_k8s-app app

      customParsers: |-
        [PARSER]
          name containerd
          format regex
          regex ^(?<time>[^ ]+) (?<stream>stdout|stderr) (?<logtag>[^ ]*) (?<log>.*)$
          time_key time
          time_format %Y-%m-%dT%H:%M:%S.%L%z

        # JSON parser for structured application logs
        [PARSER]
          name json_structured
          format json
          time_key timestamp
          time_format %Y-%m-%dT%H:%M:%S.%L%z

        # Multiline parser for Java/Kotlin stack traces
        [MULTILINE_PARSER]
          name multiline-java
          type regex
          flush_timeout 1000
          rule "start_state" "/^\d{4}-\d{2}-\d{2}/" "cont"
          rule "cont" "/^\s+at\s/" "cont"
          rule "cont" "/^\s+\.\.\./" "cont"
          rule "cont" "/^Caused by:/" "cont"

        # Multiline parser for Python tracebacks
        [MULTILINE_PARSER]
          name multiline-python
          type regex
          flush_timeout 1000
          rule "start_state" "/^Traceback/" "python_tb"
          rule "python_tb" "/^\s+File/" "python_tb"
          rule "python_tb" "/^\s+/" "python_tb"
          rule "python_tb" "/^\w+Error/" "start_state"

        # Multiline parser for Go panics
        [MULTILINE_PARSER]
          name multiline-go
          type regex
          flush_timeout 1000
          rule "start_state" "/^panic:/" "go_panic"
          rule "go_panic" "/^goroutine/" "go_panic"
          rule "go_panic" "/^\t/" "go_panic"

      outputs: |-
        [OUTPUT]
          name http
          match kubernetes.*
          host victoria-logs-server.observability.svc.cluster.local
          port 9428
          uri /insert/jsonline?_stream_fields=stream,k_namespace_name,k_pod_name,app&_msg_field=log&_time_field=date
          format json_lines
          json_date_format iso8601
          compress gzip
          # Retry configuration for reliability
          retry_limit 5
          # Storage buffer for backpressure handling
          storage.total_limit_size 1G
    dashboards:
      enabled: true
    serviceMonitor:
      enabled: true
    logLevel: warn
    resources:
      requests:
        cpu: 50m
        memory: 128Mi
      limits:
        memory: 512Mi
    # Volume for persistent buffer storage
    extraVolumes:
      - name: flb-storage
        hostPath:
          path: /var/log/flb-storage
          type: DirectoryOrCreate
    extraVolumeMounts:
      - name: flb-storage
        mountPath: /var/log/flb-storage
