---
apiVersion: gateway.kgateway.dev/v1alpha1
kind: Backend
metadata:
  name: pocket-id-oidc-qbittorrent
spec:
  type: Static
  static:
    hosts:
      - host: pocket-id.auth.svc.cluster.local
        port: 1411
---
apiVersion: gateway.kgateway.dev/v1alpha1
kind: GatewayExtension
metadata:
  name: qbittorrent-oidc
spec:
  oauth2:
    backendRef:
      kind: Backend
      group: gateway.kgateway.dev
      name: pocket-id-oidc-qbittorrent
    authorizationEndpoint: https://id.${SECRET_DOMAIN}/authorize
    tokenEndpoint: https://id.${SECRET_DOMAIN}/api/oidc/token
    endSessionEndpoint: https://id.${SECRET_DOMAIN}/api/oidc/end-session
    credentials:
      clientID: qbittorrent
      clientSecretRef:
        name: qbittorrent-oidc-secret
    redirectURI: https://qbittorrent.${SECRET_DOMAIN}/oauth2/callback
    logoutPath: /oauth2/logout
    scopes:
      - openid
      - email
      - profile
---
apiVersion: gateway.kgateway.dev/v1alpha1
kind: TrafficPolicy
metadata:
  name: qbittorrent-oidc
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: qbittorrent
  oauth2:
    extensionRef:
      name: qbittorrent-oidc
