---
apiVersion: gateway.kgateway.dev/v1alpha1
kind: Backend
metadata:
  name: pocket-id-oidc-prowlarr
spec:
  type: Static
  static:
    hosts:
      - host: pocket-id.auth.svc.cluster.local
        port: 1411
---
apiVersion: gateway.kgateway.dev/v1alpha1
kind: GatewayExtension
metadata:
  name: prowlarr-oidc
spec:
  oauth2:
    backendRef:
      kind: Backend
      group: gateway.kgateway.dev
      name: pocket-id-oidc-prowlarr
    issuerURI: https://id.${SECRET_DOMAIN}
    credentials:
      clientID: prowlarr
      clientSecretRef:
        name: prowlarr-oidc-secret
    redirectURI: https://prowlarr.${SECRET_DOMAIN}/oauth2/callback
    logoutPath: /oauth2/logout
    scopes:
      - openid
      - email
      - profile
---
apiVersion: gateway.kgateway.dev/v1alpha1
kind: TrafficPolicy
metadata:
  name: prowlarr-oidc
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: prowlarr
  oauth2:
    extensionRef:
      name: prowlarr-oidc
